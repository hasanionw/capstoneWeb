<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Promos - California Fitness Gym</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.2/css/all.css">
    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <!-- Material Design Bootstrap -->
    <link href="css/mdb.min.css" rel="stylesheet">
    <!-- Your custom styles (optional) -->
    <link href="css/style.min.css" rel="stylesheet">
    <link rel="icon" href="images/gym_logo.png">
    <link href="css/theme-colors.css" rel="stylesheet">

    <style>
      body::-webkit-scrollbar {
        width: 0 !important;
      }

        .card-bodyzz {
          max-height: 325px;
          overflow-y: auto;
        }

        .flexHeader {
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .flex {
          display: flex;
          align-items: center;
          justify-content: space-between;
        }

        table > thead > tr > th {
          font-weight: bold;
          text-transform: uppercase;
        }

        table > thead > tr > th {
          font-weight: bold;
          text-transform: uppercase;
        }

        .promo-cards {
          width: 30%;
        }

        #promo-cont {
          display: flex;
          flex-wrap: wrap;
          justify-content: flex-start;
        }

        #main-div {
          display: flex;
          flex-direction: column;
          justify-content: center;
        }

        .card-img-top {
          width: 100% !important;
          height: 10vw !important;
          object-fit: cover !important;
        }
    </style>
  </head>

  <body class="grey lighten-3" >
   
    <!--Main Navigation-->
    <header>
      <nav class="navbar fixed-top navbar-light bg-darkgrey" >
        <div class="container-fluid" >
          <h6 style="margin-bottom: 0 !important;">
            Welcome, <b><span id="username" class='text-orange font-weight-bold'></span></b>!
          </h6>
          <div class="logout">
            <button id="logoutBtn" type="button" class="btn btn-sm btn-danger">LOGOUT</button>
          </div>
        </div>
      </nav>
    
      <!-- Sidebar -->
      <div class="sidebar-fixed position-fixed" style="background-color:#DF3A01">
        <br>
        <center><img src="logo.png" class="img-fluid" alt="" style="width: 200px; height: 180px;"></center>
        <br>
        <div class="list-group list-group-flush" >
          <a href="dashboard.html" class="list-group-item list-group-item-action waves-effect sidebar-items">
            <i class="fas fa-chart-pie mr-3"></i>Dashboard
          </a>
          <a href="members.html" class="list-group-item list-group-item-action waves-effect sidebar-items">
            <i class="fas fa-user mr-3"></i>Members</a>
          <a href="trainers.html" class="list-group-item list-group-item-action waves-effect sidebar-items">
            <i class="fas fa-user-shield mr-3"></i>Trainers
          </a>
          <a href="inventory.html" class="list-group-item list-group-item-action waves-effect sidebar-items">
            <i class="fas fa-dumbbell  mr-3"></i>Inventory</a>
          <a href="promos.html" class="list-group-item list-group-item-action waves-effect sidebar-item-active">
            <i class="fas fa-percent mr-3"></i>Promos
          </a>
          <a href="paymentlog.html" class="list-group-item list-group-item-action waves-effect sidebar-items">
            <i class="fas fa-money-bill-alt mr-3"></i>Payment Log
          </a>
          <a  onclick="securityReports()" class="list-group-item list-group-item-action waves-effect sidebar-items"  
        data-toggle='modal' data-target='#security'> <i class="fas fa-flag-checkered mr-3"></i>Reports
       </a>
        
        <a  onclick="securityLogtrail()" class="list-group-item list-group-item-action waves-effect sidebar-items">
          <i class="fas fa-history mr-3"></i>Logtrail
        </a>
        </div>  
      </div>
      <!-- Sidebar -->
    </header>
    <!--Main Navigation-->

    <!--Main layout-->
    <main class="pt-5 mx-lg-5" >
      <div class="container-fluid mt-5" id="main-div">
        <!-- Heading -->
        <div class="card mb-4 wow fadeIn">
          <!--Card content-->
          <div class="card-body d-sm-flex justify-content-between">
            <h4 class="mb-1 mb-sm-1 pt-1">
              <a data-toggle="modal" data-target="#add"><i style="color:#DF3A01; font-size: 25px;" data-toggle="tooltip" data-placement="top" title="Add Promo"  class="fas fa-plus mr-4"></i></a>
              Promos
            
            </h4>
            <div class="btn-group" role="group" aria-label="Basic example">
              <button type="button" id="sort-permanent" class="btn btn-sm btn-outline-orange">PERMANENT</button>
              <button type="button" id="sort-both" class="btn btn-sm btn-orange">BOTH</button>
              <button type="button" id="sort-temporary" class="btn btn-sm btn-outline-orange">TEMPORARY</button>
            </div>
            <form class="d-flex justify-content-center">
              <input type="text" placeholder="Search promo name" id="search-promos" aria-label="Search" class="form-control">
             
              </button>
            </form>
          </div>
        </div>
        <div id="promo-cont">

        </div>
      </div>
    </main>

    <div class="modal fade" id="add" >
      <div class="modal-dialog">
        <div class="modal-content" >
          <div class="modal-header" style="background-color:#DF3A01;">
            <h3 class="modal-title" style="color:white;">Add Promo </h3>  
            <button type='button' class='close' id='close-modal' data-dismiss='modal'>&times;</button>
          </div>  
          <div class="modal-body">
            <div class="row d-flex mt-1 mb-3" style="flex-direction: row; position: relative;left: 70px;">
              <div id="profilepic" style="border-radius: 50px; height: 100px; width: 100px; overflow: hidden; background-position: 50% 50%; background-size: cover;  text-align: center;">
                <img src="blank.png" id="output" alt="" style="height: 100%; width: 100%; object-fit: cover;">
                
              </div>
              
              <p><input type="file" value="upload" id="fileButton" accept="image/*" name="image"   onchange="loadFile(event)" style="display: none;"></p>
              <p><label for="fileButton" style="cursor: pointer;"><i  data-toggle="tooltip" data-placement="top" title="Add inventory picture" style="font-size: 35px;color:teal;" class="fas fa-plus-circle"></i></label></p>
               
             
              <div class="col-sm-6" style="position: relative; left: 35px;">
                <label>Promo Name</label>
                <input type="text" id="promoname" class="form-control" required placeholder="Promo Name">
              </div>

              <div class="col-sm-6" style="position: relative; right: 40px; top: 10px;">
              <progress  value="0" max="100" id="uploader">0%</progress>
              </div>
            </div>
            
            <div class="form-group">
              <div class="form-row">
                
                <div class="col-sm-6">
                  <label>Status</label>
                  <select id="stat" required class="form-control">
                    <option value="Permanent" selected>Permanent</option>
                    <option value="Temporary">Temporary</option>
                  </select>
                </div> 
                <div class="col-sm-6">
                  <label>Amount</label>
                  <input type="text" class="form-control" required id="amount" placeholder="Amount"  >
                </div> 
              </div>
            </div>
            <div class="form-group">
              <div class="form-row">
                <div class="col-sm-6 ">
                  <label>Start Date</label><br>
                  <input type="date" class="form-control" id="start" required>
                </div>
                <div class="col-sm-6 ">
                  <label>End Date</label><br>
                  <input type="date" class="form-control" id="end" required>
                </div>
              </div>
            </div>
          
            <div class="form-group">
              <div class="form-row">
                <div class="col-sm-12">
                  <label>Description</label><br>
                  <textarea rows="5" class="form-control" 
                  cols="100" style="resize: none;" class="form-control" required id="description"
                    required data-validation-required-message="Please enter description" 
                    placeholder="Enter description" maxlength="999"></textarea>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" id="addBtn" class="btn btn-orange">Add Promo</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="displayallrecords">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header"style="background-color:#DF3A01;">
            <h3 class="modal-title" style="color:white;">display<span id="fname-span"></span></h3>
            <button type='button' class='close' id='close-display' data-dismiss='modal'>&times;</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <div class="form-row">
                <div class="col-sm-6">
                  <label>ID</label>
                  <input type="text" class="form-control" id="view-id" disabled>
                </div>
                <div class="col-sm-6">
                  <label>Promo name</label>
                  <input type="text" class="form-control" id="view-promoname" disabled>
                </div>
                <div class="col-sm-6">
                  <label>Amount</label>
                  <input type="text" class="form-control" id="view-amount" disabled>
                </div>
                <div class="col-sm-6">
                  <label>Date Started</label>
                  <input type="text" class="form-control" id="view-start" disabled>
                </div>
                <div class="col-sm-6">
                  <label>Date Ended</label>
                  <input type="text" class="form-control" id="view-end" disabled>
                </div>
                <div class="col-sm-6">
                  <label>Status</label>
                  <input type="text" class="form-control" id="view-stat" disabled>
                </div>
                <div class="col-sm-6">
                  <label>Description</label>
                  <textarea id="view-description" style="height: 100px; resize: none; width: 465px;" class="form-control" disabled></textarea>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>


    

    <div class="modal fade" id="update">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header"style="background-color:#DF3A01;">
            <h3 class="modal-title" style="color:white;">Update <span id="promoname-span"></span></h3>
            <button type='button' class='close' id='close-display' data-dismiss='modal'>&times;</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <div class="form-row">
                <div class="col-sm-6">
                  <label>Promo Name</label>
                  <input type="text" required class="form-control" disabled id="updatename" placeholder="Promo Name"  >
                </div>
                <div class="col-sm-6 ">
                  <label>Update Amount</label>
                  <input  type="text" class="form-control" id="updateamount" >
                </div>
                
                <div class="col-sm-6 my-2">
                  <label>Update Starting Date</label>
                  <input type="text" class="form-control  " id="updatestart" disabled>
                  <input type="date" class="form-control   " id="updatestart" >
                </div>
                <div class="col-sm-6 my-2">
                  <label>Update Edning Date</label>
                  <input type="text" class="form-control  " id="updateend" disabled>
                  <input type="date" class="form-control" id="updateend" >
                </div>
                
                <div class="col-sm-4 my-2">
                  <label>Update Status</label>
                  <input type="text" class="form-control  " id="updatestat" disabled>              
                </div>

                <div class="col-sm-4 my-3">
                  <label></label>
                  <select id="updatestat" required class="form-control">
                    <option value="Permanent" selected>Permanent</option>
                    <option value="Temporary">Temporary</option>
                  </select>
                </div>
                <div class="col-sm-3"></div>
                <div class="col-sm-3">
                  <label>Description</label>
                  <textarea id="updatedescription" style="height: 150px; width: 440px;resize: none;" class="form-control"></textarea>
                </div>
            </div>
          </div>
          <div class="modal-footer"  style="height: 70px;">
            <button class="btn" style="background-color:#DF3A01; color:white;" id="updateBtn">Update</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- SCRIPTS -->
    <!-- JQuery -->
    <script type="text/javascript" src="js/jquery-3.4.1.min.js"></script>
    <!-- Bootstrap tooltips -->
    <script type="text/javascript" src="js/popper.min.js"></script>
    <!-- Bootstrap core JavaScript -->
    <script type="text/javascript" src="js/bootstrap.min.js"></script>
    <!-- MDB core JavaScript -->
    <script type="text/javascript" src="js/mdb.min.js"></script>
    <!-- Initializations -->

    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script> 
    <script src="jquery-3.4.1.min.js"></script>

    
    <!-- Firebase CDNs -->
    <script src="https://www.gstatic.com/firebasejs/7.8.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.8.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.8.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.8.0/firebase-storage.js"></script>
    <!-- Local script -->
    <script src='js/init.js'></script>


    <script>
      // globals
      let button = document.getElementById('addBtn');
      const date = firebase.firestore.Timestamp;
      const pro = [];

      
      filtering = (value) => {
      let results;
      return results = pro.filter(pro => pro.data.promoname.toLowerCase().includes(value.toLowerCase()) );
    }

 // Searching promo
 let searchPros = document.getElementById('search-promos');
 searchPros.onkeyup = () => {
      if(searchPros.value != '') {
        let docs = filtering(searchPros.value);
        sortingPro(docs);
      } else {
        renderCard();
      }
    }
    searchPros.value.onchange = () => {
      if(searchPros.value == '') {
        renderCard();
      }
    }

     
renderCard = () => {
        let promoCont = document.getElementById('promo-cont');
        promoCont.innerHTML = '';

        pro.forEach((pro) => {

        let card = document.createElement('div');
        card.setAttribute('data-id',pro.id);
        card.classList.add('card', 'promo-cards', 'mx-3', 'my-3');
        card.innerHTML = 
          `<img src="blank.png" class="card-img-top">
          
          <div class="card-body">
            <h3 class="card-title font-weight-bold text-orange">${pro.data.promoname}</h3>
            <h6 class="card-subtitle text-muted font-weight-bold">${pro.data.stat}</h6>
            <p class="card-text mt-2">${pro.data.description}</p>
          </div>

          <div class="card-footer">
            <button class="btn btn-sm btn-orange">View details</button>
            <i onclick='deletepromos(this.parentNode.parentNode)'
             data-toggle="tooltip" data-placement="top" title="Delete Card"
             class="far fa-trash-alt my-2" style="font-size: 25px; float: right; color: #DF3A01" ></i>

            <a  onclick='updatefunction(this.parentNode.parentNode)' data-toggle='modal' data-target='#update'>
             <i  data-toggle="tooltip" data-placement="top" title="Update Card" 
             class="fas fa-pen mx-3 my-2"   style="font-size: 25px; float: right; color: #DF3A01" ></i></a>
            
          </div>`;
        promoCont.appendChild(card);

      });

      $(function () {
        $('[data-toggle="tooltip"]').tooltip();
      });
      }

  sortingPro = (docs) => {
    let promoCont = document.getElementById('promo-cont');
    promoCont.innerHTML = '';

      if(docs.length > 0){
      docs.forEach((doc) => {
          let card = document.createElement('div');
        card.classList.add('card', 'promo-cards', 'mx-3', 'my-3');
        card.innerHTML = 
        `<img src="blank.png" class="card-img-top">
          
          <div class="card-body">
            <h3 class="card-title font-weight-bold text-orange">${doc.data.promoname}</h3>
            <h6 class="card-subtitle text-muted font-weight-bold">${doc.data.stat}</h6>
            <p class="card-text mt-2">${doc.data.description}</p>
          </div>

          <div class="card-footer">
            <button class="btn btn-sm btn-orange">View details</button>
            <i onclick='deletepromos(this.parentNode.parentNode)'
             data-toggle="tooltip" data-placement="top" title="Delete Card"
             class="far fa-trash-alt my-2" style="font-size: 25px; float: right; color: #DF3A01" ></i>

            <a  onclick='updatefunction(this.parentNode.parentNode)' data-toggle='modal' data-target='#update'>
             <i  data-toggle="tooltip" data-placement="top" title="Update Card" 
             class="fas fa-pen mx-3 my-2"   style="font-size: 25px; float: right; color: #DF3A01" ></i></a>
            
          </div>`;

          promoCont.appendChild(card);
        });
      } else {
        promoCont.innerHTML = 'no data';
      }
        }


      
      db.collection('promos')
      .where('dateAdded', '<', date.fromDate(new Date()))
      .orderBy('dateAdded', 'desc').get().then((snapshot) => {
        snapshot.forEach((doc) => {
          
          pro.push({id: doc.id, data: doc.data()});
        });
      }).then(() => {
      renderCard();
    });
      

      let sortPermanent = document.getElementById('sort-permanent');
      let sortBoth = document.getElementById('sort-both');
      let sortTemporary = document.getElementById('sort-temporary');
     

      // Sorting by BOTH
      sortBoth.onclick = () => {
        
        sortBoth.classList.add('btn-orange');
        sortBoth.classList.remove('btn-outline-orange');
        sortTemporary.classList.add('btn-outline-orange');
        sortTemporary.classList.remove('btn-orange');
        sortPermanent.classList.add('btn-outline-orange');
        sortPermanent.classList.remove('btn-orange');

        renderCard();
      }

      // Sorting by Permanent
      sortPermanent.onclick = () => {
     
        sortBoth.classList.add('btn-outline-orange');
        sortBoth.classList.remove('btn-orange');
        sortTemporary.classList.add('btn-outline-orange');
        sortTemporary.classList.remove('btn-orange');
        sortPermanent.classList.add('btn-orange');
        sortPermanent.classList.remove('btn-outline-orange');
 
      let docs = pro.filter(i => i.data.stat == 'Permanent');
      sortingPro(docs);

      }

      // Sorting by Temporary
      sortTemporary.onclick = () => {
      
        sortBoth.classList.add('btn-outline-orange');
        sortBoth.classList.remove('btn-orange');
        sortTemporary.classList.add('btn-orange');
        sortTemporary.classList.remove('btn-outline-orange');
        sortPermanent.classList.add('btn-outline-orange');
        sortPermanent.classList.remove('btn-orange');

        let docs = pro.filter(i => i.data.stat == 'Temporary');
        sortingPro(docs);
      }

    // delete card
    function deletepromos(x) {
      let dataid = x.getAttribute("data-id");
      let agree = confirm("are you sure you want to delete card?");

      if(agree === true){
      db.collection("promos").doc(dataid).delete().then(function() {
      console.log("Card successfully deleted!");
      window.location.reload();  
      })
      .catch(function(error) {
          console.error("Error removing Card: ", error);
      });
      }
    }

    
    
    
    

      button.addEventListener('click', function() {
        let promoname = document.getElementById('promoname').value;
        let amount = document.getElementById('amount').value;
        let stat = document.getElementById('stat').value;
        let start = document.getElementById('start').value;
        let end = document.getElementById('end').value;
        let description = document.getElementById('description').value;

        let startDate = date.fromDate(new Date(start));
        let endDate = date.fromDate(new Date(end));

        let promos = db.collection('promos');
        let discount = promos.where('start', '<', startDate).where('start', '>', endDate);

        if(promoname === '') {
          alert('ERROR: Promo name is required!');
        } else if(amount === '') {
          alert('ERROR: Amount is required!');
        } else if(stat === '') {
          alert('ERROR: Status is required!');
        } else if(start === '') {
          alert('ERROR: Starting date is required!');
        } else if(end === '') {
          alert('ERROR: Expiry date is required!');
        } else if(description === '') {
          alert('ERROR: Description is required!');
        } else {
          discount.get().then(function(snapshot) {
            if(snapshot.docs.length > 0) {
              alert('Error: Promo date already exists!');
            } else {
              promos.add({
                promoname: promoname,
                amount: amount,
                stat: stat,
                start: date.fromDate(new Date(start)),
                end: date.fromDate(new Date(end)),
                description: description,
                dateAdded: date.fromDate(new Date())
              }).then(function() {
                alert('Successfully added new promo!');
                window.location.reload();
              }).catch(function(error) {
                alert(error.message);
              });
            }
          });
        }
      });

      auth.onAuthStateChanged(function(user) {
        let span = document.getElementById('username');

        if(user) {
          span.textContent = user.email;
        }
      })

      // tool tip sa plus button
      $(function () {
        $('[data-toggle="tooltip"]').tooltip();
      });


      // logout script
      document.getElementById("logoutBtn").addEventListener("click", function() {
        let x = confirm("Are you sure?");
        if(x === true){
          auth.signOut().then(function() {
            alert("Logout successful!");
            window.location.href = "index.html";
          }).catch((err) => {
            alert(`ERROR: ${err.message}`);
          });
        }
      });

      auth.onAuthStateChanged(function(user){
        if(user) {
          
        } else {
          window.location.href = "index.html";
        }
      })


     // para mo upload kag picture    
var loadFile = function(event) {
                  var image = document.getElementById('output');
                  image.src = URL.createObjectURL(event.target.files[0]);
              };

      
   // update function
   function updatefunction(x) {
      let updatename = document.getElementById('updatename');
      let updateamount = document.getElementById('updateamount');
      let updatestart = document.getElementById('updatestart');
      let updateend = document.getElementById('updateend');
      let updatestat = document.getElementById('updatestat');
      let updatedescription = document.getElementById('updatedescription');
      let span = document.getElementById('promoname-span');
      let id = x.getAttribute("data-id");
      let qwe = pro.filter(pro => pro.id == id);
      let er = qwe[0];
      let data = er.data;

      db.collection('promos').doc(id).get().then(function(doc) {
        span.textContent = doc.data().promoname; // firstname na mo display sa update modal
        updatename.value = doc.data().promoname;
        updateamount.value = doc.data().amount;
        updatestart.value = doc.data().start;
        updatestat.value = doc.data().stat;
        
        let us = doc.data().start.toDate();
        let ue = doc.data().end.toDate();
        updatestart.value = `${months[us.getMonth()]}/${us.getDate()}/${us.getFullYear()}`;
        updateend.value = `${months[ue.getMonth()]}/${ue.getDate()}/${ue.getFullYear()}`;

        updatedescription.value = doc.data().description;

      document.getElementById('updateBtn').addEventListener('click', () => {
          let amount = document.getElementById('updateamount').value;
          let start = document.getElementById('updatestart').value;
          let end = document.getElementById('updateend').value;
          let stat = document.getElementById('updatestat').value;
          let description = document.getElementById('updatedescription').value;

          db.collection('promos').doc(doc.id).update({
            amount: amount,
            start: start,
            end: end,
            stat: stat,
            description: description,
                  
          }).then(() => {
            alert('Successfully updated Promo!');
            window.location.reload();
          }).catch((error) => {
            alert(`Error: ${error.message}`);
          });
        });
      });
    }
  
     // para mo upload kag picture
    var uploader = document.getElementById('uploader');
    var fileButton = document.getElementById('fileButton');
   
    fileButton.addEventListener('change', function(e){
        var file = e.target.files[0];
        var storageRef = firebase.storage().ref('promosimage/' + file.name);
        var task = storageRef.put(file);
       
        task.on('state_changed',
            function progress(snapshot){
                var percentage = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                uploader.value = percentage;
            },
            function error(err){

            },
            function complete(){
             alert('successfuly upload picture')
            }  
        );
    });


    function securityReports() {
        
        let password = prompt('security password');
      if(password == '123')
      {
        window.location.href = "reports.html";
      }
    }

    function securityLogtrail() {
      
      let password = prompt('security password');
    if(password == '123')
    {
      window.location.href = "logtrail.html";
    } 
  }

    </script>
  </body>
</html>